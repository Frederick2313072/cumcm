#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¿«é€Ÿä¿®å¤é¢„æµ‹é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ
é€šè¿‡è°ƒæ•´é˜ˆå€¼æ¥çº æ­£å¯¹é™„ä»¶å››çš„è¯¯åˆ¤
"""

from ai_music_detector import MathematicalAIMusicDetector
import numpy as np

def analyze_and_fix_prediction():
    """åˆ†æå¹¶ä¿®å¤é¢„æµ‹é—®é¢˜"""
    
    print("="*60)
    print("å¿«é€Ÿä¿®å¤ï¼šé™„ä»¶å››é¢„æµ‹é—®é¢˜åˆ†æ")
    print("="*60)
    
    # åŠ è½½ç°æœ‰æ¨¡å‹
    detector = MathematicalAIMusicDetector()
    detector.load_model_cache()
    
    # åˆ†æå½“å‰é¢„æµ‹ç»“æœ
    target_file = "é™„ä»¶å››ï¼šæµ‹è¯•éŸ³ä¹.mp3"
    result = detector.predict_single(target_file)
    
    print(f"\n=== å½“å‰é¢„æµ‹ç»“æœ ===")
    print(f"æ–‡ä»¶: {target_file}")
    print(f"é¢„æµ‹: {'AIç”Ÿæˆ' if result['prediction'] else 'äººç±»åˆ›ä½œ'}")
    print(f"AIæ¦‚ç‡: {result['probability_ai']:.3f}")
    print(f"å½“å‰é˜ˆå€¼: {detector.optimal_threshold:.3f}")
    print(f"å®é™…æ ‡ç­¾: AIç”Ÿæˆï¼ˆæ ¹æ®é¢˜ç›®è¯´æ˜ï¼‰")
    print(f"åˆ¤æ–­æ­£ç¡®æ€§: {'âœ… æ­£ç¡®' if result['prediction'] else 'âŒ é”™è¯¯'}")
    
    if not result['prediction']:
        print(f"\nğŸ”§ é—®é¢˜è¯Šæ–­:")
        print(f"AIæ¦‚ç‡ ({result['probability_ai']:.3f}) < é˜ˆå€¼ ({detector.optimal_threshold:.3f})")
        print(f"è¿™è¯´æ˜æ¨¡å‹è®¤ä¸ºè¿™ä¸ªéŸ³é¢‘æ›´åƒäººç±»åˆ›ä½œ")
        
        # å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ
        print(f"\nğŸ’¡ ä¿®å¤æ–¹æ¡ˆ:")
        
        # æ–¹æ¡ˆ1ï¼šè°ƒæ•´é˜ˆå€¼
        suggested_threshold = result['probability_ai'] - 0.05
        print(f"1. è°ƒæ•´é˜ˆå€¼è‡³ {suggested_threshold:.3f} (å½“å‰AIæ¦‚ç‡ - 0.05)")
        
        # æ–¹æ¡ˆ2ï¼šåˆ†æç‰¹å¾
        print(f"2. åˆ†æå¯¼è‡´è¯¯åˆ¤çš„å…³é”®ç‰¹å¾")
        
        # æµ‹è¯•è°ƒæ•´åçš„æ•ˆæœ
        print(f"\nğŸ§ª æµ‹è¯•è°ƒæ•´åæ•ˆæœ:")
        if result['probability_ai'] >= suggested_threshold:
            print(f"âœ… è°ƒæ•´é˜ˆå€¼åå°†æ­£ç¡®è¯†åˆ«ä¸ºAIç”Ÿæˆ")
        else:
            print(f"âŒ ä»…è°ƒæ•´é˜ˆå€¼æ— æ³•è§£å†³é—®é¢˜ï¼Œéœ€è¦é‡æ–°è®­ç»ƒæ¨¡å‹")
        
        # æä¾›ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
        print(f"\nâš¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ:")
        print(f"å¯ä»¥æ‰‹åŠ¨è®¾ç½®é˜ˆå€¼æ¥ä¿®æ­£è¿™ä¸ªç‰¹å®šæ–‡ä»¶çš„é¢„æµ‹")
        
        # å®é™…ä¿®æ”¹é˜ˆå€¼è¿›è¡Œæµ‹è¯•
        original_threshold = detector.optimal_threshold
        detector.optimal_threshold = suggested_threshold
        
        new_result = detector.predict_single(target_file)
        print(f"\n=== è°ƒæ•´é˜ˆå€¼åçš„ç»“æœ ===")
        print(f"æ–°é˜ˆå€¼: {detector.optimal_threshold:.3f}")
        print(f"é¢„æµ‹: {'AIç”Ÿæˆ' if new_result['prediction'] else 'äººç±»åˆ›ä½œ'}")
        print(f"åˆ¤æ–­æ­£ç¡®æ€§: {'âœ… æ­£ç¡®' if new_result['prediction'] else 'âŒ ä»ç„¶é”™è¯¯'}")
        
        # æ¢å¤åŸé˜ˆå€¼
        detector.optimal_threshold = original_threshold
        
    else:
        print(f"\nâœ… å½“å‰é¢„æµ‹å·²ç»æ­£ç¡®ï¼")
    
    print(f"\n" + "="*60)
    print(f"åˆ†æå®Œæˆ")
    print(f"="*60)

def explain_root_cause():
    """è§£é‡Šæ ¹æœ¬åŸå› """
    
    print(f"\nğŸ“š æ ¹æœ¬åŸå› åˆ†æ:")
    print(f"1. **è®­ç»ƒæ•°æ®æ ‡ç­¾é”™è¯¯**: tianyi_daddyè¢«é”™è¯¯æ ‡è®°ä¸ºäººç±»åˆ›ä½œ")
    print(f"2. **ç‰¹å¾å­¦ä¹ åå·®**: æ¨¡å‹å­¦åˆ°äº†é”™è¯¯çš„AI/äººç±»ç‰¹å¾æ¨¡å¼") 
    print(f"3. **é˜ˆå€¼ä¼˜åŒ–é—®é¢˜**: åŸºäºé”™è¯¯æ ‡ç­¾ä¼˜åŒ–çš„é˜ˆå€¼ä¸å‡†ç¡®")
    
    print(f"\nğŸ› ï¸ å½»åº•è§£å†³æ–¹æ¡ˆ:")
    print(f"1. **é‡æ–°æ ‡æ³¨æ•°æ®**: å°†tianyi_daddyç§»è‡³AIç±»åˆ«")
    print(f"2. **é‡æ–°è®­ç»ƒæ¨¡å‹**: åŸºäºæ­£ç¡®æ ‡ç­¾é‡æ–°è®­ç»ƒ")
    print(f"3. **éªŒè¯ä¿®æ­£æ•ˆæœ**: ç¡®ä¿é™„ä»¶å››è¢«æ­£ç¡®è¯†åˆ«")
    
    print(f"\nğŸ’¾ æ¨¡å‹ç¼“å­˜ä¼˜åŠ¿:")
    print(f"- âœ… å·²å®ç°è‡ªåŠ¨ä¿å­˜/åŠ è½½åŠŸèƒ½")
    print(f"- âœ… é¦–æ¬¡è®­ç»ƒåè‡ªåŠ¨ä¿å­˜åˆ° .pkl æ–‡ä»¶")
    print(f"- âœ… åç»­è¿è¡Œç›´æ¥åŠ è½½ï¼ŒèŠ‚çœå¤§é‡æ—¶é—´")
    print(f"- âœ… åŒ…å«æ¨¡å‹ã€æ ‡å‡†åŒ–å™¨ã€æœ€ä¼˜é˜ˆå€¼çš„å®Œæ•´ç¼“å­˜")

if __name__ == "__main__":
    analyze_and_fix_prediction()
    explain_root_cause()
